<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<title>Businessio â€¢ Explore</title>
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<style>
body{margin:0;font-family:Arial,sans-serif;background:#f4f6ff;padding:10px;}
.business-card{
  background:#fff;
  border-radius:12px;
  padding:15px;
  margin-bottom:12px;
  box-shadow:0 5px 15px rgba(0,0,0,.05);
}
.business-card img{
  width:100%;
  height:150px;
  object-fit:cover;
  border-radius:8px;
}
.business-info h4{margin:5px 0;}
.business-info p{margin:0;color:#555;}
button{
  padding:8px 12px;
  border:none;
  border-radius:8px;
  background:#1f4cff;
  color:#fff;
  cursor:pointer;
  margin-top:8px;
}
</style>
</head>
<body>

<h2>Explore Businesses</h2>
<div id="businessList">Loading businesses...</div>

<script type="module">
import { initializeApp } from "https://www.gstatic.com/firebasejs/12.7.0/firebase-app.js";
import { getAuth, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/12.7.0/firebase-auth.js";
import { getFirestore, collection, getDocs, addDoc, query, where, doc, setDoc } from "https://www.gstatic.com/firebasejs/12.7.0/firebase-firestore.js";

const firebaseConfig = {
  apiKey: "AIzaSyDeFlOeRoiNjqH9LAclnqnehXNY6scPqzE",
  authDomain: "businessio-37c69.firebaseapp.com",
  projectId: "businessio-37c69"
};

const app = initializeApp(firebaseConfig);
const auth = getAuth(app);
const db = getFirestore(app);

let currentUser = null;
const businessListEl = document.getElementById("businessList");

/* AUTH */
onAuthStateChanged(auth,user=>{
  if(!user) location.href="index.html";
  currentUser = user;
  loadBusinesses();
});

/* LOAD BUSINESSES */
async function loadBusinesses(){
  businessListEl.innerHTML = "";
  const snap = await getDocs(collection(db,"businesses"));
  if(snap.empty){
    businessListEl.innerHTML = "<p>No businesses yet.</p>";
    return;
  }
  snap.forEach(docSnap=>{
    const data = docSnap.data();
    const card = document.createElement("div");
    card.classList.add("business-card");
    card.innerHTML = `
      <img src="${data.photo || 'https://cdn-icons-png.flaticon.com/512/847/847969.png'}">
      <div class="business-info">
        <h4>${data.name}</h4>
        <p>${data.description || ''}</p>
        <p><b>Location:</b> ${data.location || ''}</p>
        <button onclick="openBusinessChat('${docSnap.id}','${data.name}','${data.photo || ''}')">${data.type==='product'?'Buy':'Apply'}</button>
      </div>
    `;
    businessListEl.appendChild(card);
  });
}

/* OPEN BUSINESS CHAT */
async function openBusinessChat(businessId,businessName,businessPhoto){
  // Check if chat exists
  const q = query(collection(db,"chats"), where("participants","array-contains",currentUser.uid));
  const snaps = await getDocs(q);
  let chatId = null;

  snaps.forEach(docSnap=>{
    const data = docSnap.data();
    if(data.participants.includes(businessId)){
      chatId = docSnap.id;
    }
  });

  // Create chat if it doesn't exist
  if(!chatId){
    const newChatRef = await addDoc(collection(db,"chats"),{
      participants:[currentUser.uid,businessId],
      contactNames:{ [currentUser.uid]:currentUser.displayName || "You", [businessId]:businessName },
      contactPhotos:{ [currentUser.uid]:currentUser.photoURL || "", [businessId]:businessPhoto || "" },
      unread:{ [currentUser.uid]:0, [businessId]:0 },
      lastMessage:""
    });
    chatId = newChatRef.id;
  }

  // Open chat
  localStorage.setItem("openChatId",chatId);
  window.location.href = "chats.html";
}
</script>
</body>
</html>
