<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<title>Businessio ‚Ä¢ Chats</title>
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<style>
body{
  margin:0;
  font-family:Arial,sans-serif;
  background:#f4f6ff;
}
/* HEADER */
.header{
  display:flex;
  align-items:center;
  justify-content:space-between;
  padding:15px;
  background:#1f4cff;
  color:#fff;
  position:sticky;
  top:0;
  z-index:100;
}
.menu-btn{
  font-size:24px;
  cursor:pointer;
}
/* SIDE MENU */
.side-menu{
  position:fixed;
  top:0;
  left:-260px;
  width:260px;
  height:100%;
  background:#fff;
  box-shadow:2px 0 20px rgba(0,0,0,.2);
  transition:.3s;
  z-index:1001;
}
.side-menu.active{left:0;}
.side-menu h3{
  margin:0;
  padding:20px;
  background:#1f4cff;
  color:#fff;
}
.side-menu ul{
  list-style:none;
  padding:0;
  margin:0;
}
.side-menu li{
  padding:15px 20px;
  border-bottom:1px solid #eee;
  cursor:pointer;
}
.side-menu li:hover{
  background:#f0f2ff;
}
/* OVERLAY */
.overlay{
  position:fixed;
  top:0;left:0;
  width:100%;height:100%;
  background:rgba(0,0,0,.4);
  display:none;
  z-index:1000;
}
.overlay.show{display:block}
/* CONTENT */
.content{
  padding:10px;
  display:flex;
  flex-direction:column;
  height:calc(100vh - 60px);
}
/* CHAT LIST */
.chat-list{
  flex:1;
  overflow-y:auto;
}
.contact{
  display:flex;
  align-items:center;
  padding:10px;
  background:#fff;
  margin-bottom:8px;
  border-radius:10px;
  cursor:pointer;
  box-shadow:0 5px 15px rgba(0,0,0,.05);
}
.contact img{
  width:50px;
  height:50px;
  border-radius:50%;
  object-fit:cover;
}
.contact-info{
  margin-left:10px;
  flex:1;
}
.contact-info h4{
  margin:0;
  font-size:16px;
  font-weight:bold;
}
.contact-info p{
  margin:2px 0;
  font-size:14px;
  color:#555;
}
.badge{
  background:#1f4cff;
  color:#fff;
  padding:2px 6px;
  border-radius:10px;
  font-size:12px;
}
/* CHAT ROOM */
.chat-room{
  flex:2;
  display:flex;
  flex-direction:column;
  background:#fff;
  border-radius:10px;
  margin-top:10px;
  padding:10px;
  box-shadow:0 5px 15px rgba(0,0,0,.05);
  display:none;
}
.messages{
  flex:1;
  overflow-y:auto;
}
.message{
  margin:5px 0;
  padding:8px 10px;
  border-radius:10px;
  max-width:70%;
}
.message.me{
  background:#1f4cff;
  color:#fff;
  align-self:flex-end;
}
.message.other{
  background:#eee;
  color:#000;
  align-self:flex-start;
}
.send-box{
  display:flex;
  margin-top:5px;
}
.send-box input{
  flex:1;
  padding:8px;
  border-radius:10px;
  border:1px solid #ccc;
}
.send-box button{
  background:#1f4cff;
  color:#fff;
  border:none;
  padding:8px 12px;
  border-radius:10px;
  margin-left:5px;
  cursor:pointer;
}
</style>
</head>
<body>

<!-- HEADER -->
<div class="header">
  <div class="menu-btn" onclick="toggleMenu()">‚ò∞</div>
  <h3>Chats</h3>
  <div></div>
</div>

<!-- SIDE MENU -->
<div class="side-menu" id="menu">
  <h3>Menu</h3>
  <ul>
    <li onclick="goPage('home')">üè† Home</li>
    <li onclick="goPage('my-businesses')">üè¢ My Businesses</li>
    <li onclick="goPage('chats')">üí¨ My Chats</li>
    <li onclick="goPage('complaints')">üì© Complaints</li>
    <li onclick="goPage('about')">‚Ñπ About</li>
    <li onclick="logout()">üö™ Logout</li>
  </ul>
</div>

<div class="overlay" id="overlay" onclick="toggleMenu()"></div>

<div class="content">
  <!-- CHAT LIST -->
  <div class="chat-list" id="chatList">
    <p>Loading chats...</p>
  </div>

  <!-- CHAT ROOM -->
  <div class="chat-room" id="chatRoom">
    <div class="messages" id="messages"></div>
    <div class="send-box">
      <input type="text" id="msgInput" placeholder="Type a message">
      <button onclick="sendMessage()">Send</button>
    </div>
  </div>
</div>

<script type="module">
import { initializeApp } from "https://www.gstatic.com/firebasejs/12.7.0/firebase-app.js";
import { getAuth, onAuthStateChanged, signOut } from "https://www.gstatic.com/firebasejs/12.7.0/firebase-auth.js";
import { getFirestore, collection, addDoc, query, where, getDocs, orderBy, onSnapshot, serverTimestamp, doc, setDoc } from "https://www.gstatic.com/firebasejs/12.7.0/firebase-firestore.js";

const firebaseConfig = {
  apiKey: "AIzaSyDeFlOeRoiNjqH9LAclnqnehXNY6scPqzE",
  authDomain: "businessio-37c69.firebaseapp.com",
  projectId: "businessio-37c69"
};

const app = initializeApp(firebaseConfig);
const auth = getAuth(app);
const db = getFirestore(app);

let currentUser = null;
let currentChatId = null;

const chatListEl = document.getElementById("chatList");
const chatRoomEl = document.getElementById("chatRoom");
const messagesEl = document.getElementById("messages");
const msgInput = document.getElementById("msgInput");

/* AUTH */
onAuthStateChanged(auth, async user=>{
  if(!user) location.href="index.html";
  currentUser = user;
  loadChats();
});

/* LOAD CHATS */
async function loadChats(){
  chatListEl.innerHTML = "";
  const q = query(collection(db,"chats"), where("participants", "array-contains", currentUser.uid));
  const snaps = await getDocs(q);
  if(snaps.empty){
    chatListEl.innerHTML="<p>No chats yet.</p>";
    return;
  }
  snaps.forEach(docSnap=>{
    const data = docSnap.data();
    const contactId = data.participants.find(id=>id!==currentUser.uid);
    const contactName = data.contactNames ? data.contactNames[contactId] || "Contact" : "Contact";
    const unread = data.unread && data.unread[currentUser.uid] ? data.unread[currentUser.uid] : 0;
    const contactEl = document.createElement("div");
    contactEl.classList.add("contact");
    contactEl.innerHTML = `<img src="${data.contactPhotos?data.contactPhotos[contactId]:'https://cdn-icons-png.flaticon.com/512/847/847969.png'}">
                           <div class="contact-info">
                             <h4>${contactName}</h4>
                             <p>${data.lastMessage || ""}</p>
                           </div>
                           ${unread>0?`<div class="badge">${unread}</div>`:""}`;
    contactEl.onclick = ()=>openChat(docSnap.id, contactId, contactName);
    chatListEl.appendChild(contactEl);
  });
}

/* OPEN CHAT ROOM */
function openChat(chatId, contactId, contactName){
  currentChatId = chatId;
  chatRoomEl.style.display = "flex";
  messagesEl.innerHTML = "";

  const msgsQuery = query(collection(db,"chats",chatId,"messages"), orderBy("timestamp"));
  onSnapshot(msgsQuery, async snap=>{
    messagesEl.innerHTML="";
    const now = Date.now();
    const oneWeek = 7*24*60*60*1000;

    snap.forEach(async docSnap=>{
      const msg = docSnap.data();
      const msgTime = msg.timestamp?.toMillis?.() || now;

      // AUTO DELETE after 1 week
      if(now - msgTime > oneWeek){
        await docSnap.ref.delete();
        return;
      }

      // DISPLAY MESSAGE
      const msgEl = document.createElement("div");
      msgEl.classList.add("message", msg.sender===currentUser.uid?"me":"other");
      msgEl.textContent = msg.text;
      messagesEl.appendChild(msgEl);
      messagesEl.scrollTop = messagesEl.scrollHeight;

      // NOTIFICATION SOUND
      if(msg.sender!==currentUser.uid){
        const audio = new Audio('https://freesound.org/data/previews/316/316847_4939433-lq.mp3');
        audio.play();
      }
    });

    // Reset unread count
    const chatRef = doc(db,"chats",chatId);
    await setDoc(chatRef,{ unread:{ [currentUser.uid]:0 }},{ merge:true });
  });
}

/* SEND MESSAGE */
window.sendMessage = async ()=>{
  const text = msgInput.value.trim();
  if(!text || !currentChatId) return;
  await addDoc(collection(db,"chats",currentChatId,"messages"), {
    sender: currentUser.uid,
    text,
    timestamp: serverTimestamp()
  });
  msgInput.value="";
};

/* MENU */
window.toggleMenu = ()=>{
  menu.classList.toggle("active");
  overlay.classList.toggle("show");
};
window.goPage = page=>{
  switch(page){
    case "home": window.location.href="home.html"; break;
    case "my-businesses": window.location.href="my-businesses.html"; break;
    case "chats": window.location.href="chats.html"; break;
    case "complaints": window.location.href="complaints.html"; break;
    case "about": window.location.href="about.html"; break;
  }
  toggleMenu();
};

/* LOGOUT */
window.logout = async ()=>{
  await signOut(auth);
  location.href="index.html";
};
</script>

</body>
</html>
